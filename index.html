<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Civil | Chile City RP</title>
<style>
:root{--azul:#003366;--fondo:#f0f4fb;--blanco:#fff;}
body{font-family:Arial,sans-serif;background:var(--fondo);margin:0;padding:20px;}
h2{color:var(--azul);}
.btn{background:var(--azul);color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin:4px;}
.btn.red{background:#b22222;}
.btn.secondary{background:#6b7fa6;}
input, select{width:100%;padding:6px;margin-top:4px;border-radius:6px;border:1px solid #ccd6ea;}
.card{background:var(--blanco);padding:12px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:12px;}
.foto-preview{width:120px;height:150px;background:#e9eef9;border:1px dashed #aebfdb;display:flex;align-items:center;justify-content:center;color:#556;margin-top:8px;border-radius:6px;overflow:hidden;}
.foto-preview img{width:100%;height:100%;object-fit:cover;}
.cedula-wrap{margin-top:20px;}
.cedula{position:relative;background:linear-gradient(90deg,#e8f0ff 0%, #ffffff 60%);border:2px solid var(--azul);border-radius:12px;padding:18px;box-shadow:0 8px 22px rgba(0,0,0,0.12);font-size:14px;color:#033;margin-bottom:12px;}
.cedula .flag{font-weight:700;color:var(--azul);text-align:center;letter-spacing:2px;margin-bottom:6px;}
.cedula .photo{position:absolute;left:20px;top:50px;width:120px;height:150px;border:2px solid var(--azul);background:#f6f8ff;overflow:hidden;border-radius:6px;}
.cedula .photo img{width:100%;height:100%;object-fit:cover;}
.datos{margin-left:160px;padding-top:10px;}
.dato-line{display:flex;gap:6px;margin-bottom:8px;align-items:center;}
.label{width:120px;font-weight:700;color:var(--azul);}
.valor{background:rgba(255,255,255,0.6);padding:6px 8px;border-radius:6px;min-width:150px;}
.rut{position:absolute;right:18px;top:18px;background:var(--azul);color:white;padding:8px 10px;border-radius:6px;font-weight:700;}
</style>
</head>
<body>

<h2>Registro Civil | Chile City RP</h2>

<!-- LOGIN / REGISTRO -->
<div id="pantallaLogin" class="card">
  <h3>Inicia sesión o crea una cuenta</h3>
  <label>Usuario de Discord</label>
  <input id="loginUsuario" type="text" placeholder="Ej: usuario#0001">
  <label>Contraseña</label>
  <input id="loginPassword" type="password">
  <p style="color:#b22222;font-size:12px;"><b>⚠️ No utilices tu contraseña de Discord.</b></p>
  <button class="btn" id="btnLogin">Iniciar Sesión</button>
  <button class="btn secondary" id="btnRegistro">Crear Cuenta</button>
</div>

<!-- PANTALLA PRINCIPAL -->
<div id="pantallaInicio" class="card" style="display:none;">
  <button class="btn" id="btnCrearC">Crear Cédula</button>
  <button class="btn" id="btnVerC" style="display:none;">Ver Cédula</button>
  <button class="btn" id="btnPolicia">Entrar como Policía</button>
  <button class="btn" id="btnModerador">Entrar como Moderador</button>
  <button class="btn red" id="btnCerrarSesion">Cerrar Sesión</button>
</div>

<!-- FORMULARIO DE CÉDULA -->
<div id="formDNI" class="card" style="display:none;">
  <h3>Formulario de Cédula</h3>
  <label>Nombres</label><input id="nombres" type="text">
  <label>Apellidos</label><input id="apellidos" type="text">
  <label>Nacionalidad</label><input id="nacionalidad" type="text" value="Chilena">
  <label>Género</label><select id="genero"><option>Masculino</option><option>Femenino</option></select>
  <label>Fecha de nacimiento</label><input id="nacimiento" type="date">
  <label>Foto</label><input id="foto" type="file" accept="image/*">
  <div class="foto-preview" id="fotoPreviewForm"><span>Previsualización</span></div>
  <button class="btn" id="btnGenerar">Generar Cédula</button>
</div>

<!-- MODO POLICÍA -->
<div id="modoPolicia" class="card" style="display:none;">
  <h3>Modo Policía</h3>
  <input type="text" id="buscarUsuarioPol" placeholder="Buscar usuario">
  <button class="btn" id="btnBuscarPol">Buscar</button>
  <div id="dniPolicia"></div>
  <button class="btn red" id="cerrarPolicia">Cerrar sesión</button>
</div>

<!-- MODO MODERADOR -->
<div id="modoModerador" class="card" style="display:none;">
  <h3>Modo Moderador</h3>
  <input type="text" id="buscarUsuarioMod" placeholder="Buscar usuario">
  <button class="btn" id="btnBuscarMod">Buscar</button>
  <div id="dniModerador"></div>
  <button class="btn red" id="cerrarMod">Cerrar sesión</button>
</div>

<div class="cedula-wrap" id="cedulaWrap"></div>

<script>
let usuarios = JSON.parse(localStorage.getItem('usuarios')||'[]');
let cedulas = JSON.parse(localStorage.getItem('cedulas')||'[]');
let usuarioActual = null;

// Guardado local
function guardarUsuarios(){localStorage.setItem('usuarios',JSON.stringify(usuarios));}
function guardarCedulas(){localStorage.setItem('cedulas',JSON.stringify(cedulas));}

// Generadores
function generarNumDocumento(){return Math.floor(100000000 + Math.random()*900000000);}
function generarRutConDV(){let r='';for(let i=0;i<(Math.random()<0.5?7:8);i++)r+=Math.floor(Math.random()*10);const rev=r.split('').reverse().map(n=>parseInt(n,10));let f=2,s=0;for(const d of rev){s+=d*f;f=f===7?2:f+1;}let m=11-(s%11),dv=m===11?'0':m===10?'K':String(m);return r+'-'+dv;}
function fechaHoyYVencimiento(){const h=new Date();const v=new Date(h);v.setFullYear(v.getFullYear()+5);return{emision:h.toLocaleDateString(),vencimiento:v.toLocaleDateString()};}

// Mostrar solo botones correspondientes
function actualizarBotonesLogin(){
  const btnLogin=document.getElementById('btnLogin');
  const btnRegistro=document.getElementById('btnRegistro');
  if(usuarios.length===0){
    btnLogin.style.display='none';
    btnRegistro.style.display='inline-block';
  }else{
    btnLogin.style.display='inline-block';
    btnRegistro.style.display='none';
  }
}

// --- LOGIN / REGISTRO ---
document.getElementById('btnLogin').onclick=()=>{
  const user=document.getElementById('loginUsuario').value.trim();
  const pass=document.getElementById('loginPassword').value.trim();
  const u=usuarios.find(x=>x.user===user && x.pass===pass);
  if(!u) return alert('Usuario o contraseña incorrectos');
  usuarioActual=user;
  document.getElementById('pantallaLogin').style.display='none';
  document.getElementById('pantallaInicio').style.display='block';
  actualizarBotonVerC(user);
}

document.getElementById('btnRegistro').onclick=()=>{
  const user=document.getElementById('loginUsuario').value.trim();
  const pass=document.getElementById('loginPassword').value.trim();
  if(!user||!pass) return alert('Completa ambos campos');
  if(usuarios.some(u=>u.user===user)) return alert('Ese usuario ya existe');
  usuarios.push({user,pass}); guardarUsuarios();
  alert('Cuenta creada exitosamente. Ahora inicia sesión.');
  actualizarBotonesLogin();
}

// --- Cerrar sesión ---
document.getElementById('btnCerrarSesion').onclick=()=>{
  usuarioActual=null;
  document.getElementById('pantallaInicio').style.display='none';
  document.getElementById('pantallaLogin').style.display='block';
}

// --- Crear / Ver Cédula ---
function actualizarBotonVerC(user){
  const tiene=cedulas.some(d=>d.usuario===user);
  document.getElementById('btnVerC').style.display=tiene?'inline-block':'none';
  document.getElementById('btnCrearC').style.display=tiene?'none':'inline-block';
}
document.getElementById('btnCrearC').onclick=()=>{
  document.getElementById('formDNI').style.display='block';
  document.getElementById('pantallaInicio').style.display='none';
}
document.getElementById('btnGenerar').onclick=()=>{
  const n=document.getElementById('nombres').value.trim();
  const a=document.getElementById('apellidos').value.trim();
  const nac=document.getElementById('nacionalidad').value.trim();
  const g=document.getElementById('genero').value;
  const fn=document.getElementById('nacimiento').value;
  const foto=document.getElementById('foto').files[0];
  if(!n||!a||!nac||!fn||!foto) return alert('Completa todos los campos.');
  if(cedulas.some(c=>c.usuario===usuarioActual)) return alert('Ya tienes una cédula.');
  const reader=new FileReader();
  reader.onload=e=>{
    const f=fechaHoyYVencimiento();
    const dni={usuario:usuarioActual,nombres:n,apellidos:a,nacionalidad:nac,genero:g,nacimiento:fn,foto:e.target.result,rut:generarRutConDV(),numdoc:generarNumDocumento(),emision:f.emision,vencimiento:f.vencimiento};
    cedulas.push(dni); guardarCedulas();
    document.getElementById('formDNI').style.display='none';
    document.getElementById('pantallaInicio').style.display='block';
    actualizarBotonVerC(usuarioActual);
    alert('Cédula creada correctamente.');
  };
  reader.readAsDataURL(foto);
}
document.getElementById('btnVerC').onclick=()=>{
  const d=cedulas.find(x=>x.usuario===usuarioActual);
  if(!d) return alert('No se encontró la cédula.');
  const c=document.getElementById('cedulaWrap'); c.innerHTML='';
  c.appendChild(crearCedulaHTML(d));
}

// --- Crear HTML Cédula ---
function crearCedulaHTML(dni,modo){
  const div=document.createElement('div'); div.className='cedula';
  div.innerHTML=`<div class="flag">REPUBLICA DE CHILE</div>
  <div class="rut">${dni.rut}</div>
  <div class="photo"><img src="${dni.foto}"></div>
  <div class="datos">
    <div class="dato-line"><div class="label">Nombres:</div><div class="valor">${dni.nombres}</div></div>
    <div class="dato-line"><div class="label">Apellidos:</div><div class="valor">${dni.apellidos}</div></div>
    <div class="dato-line"><div class="label">Género:</div><div class="valor">${dni.genero}</div></div>
    <div class="dato-line"><div class="label">Nacionalidad:</div><div class="valor">${dni.nacionalidad}</div></div>
    <div class="dato-line"><div class="label">F. Nacimiento:</div><div class="valor">${dni.nacimiento}</div></div>
    <div class="dato-line"><div class="label">N° Documento:</div><div class="valor">${dni.numdoc}</div></div>
    <div class="dato-line"><div class="label">Emisión:</div><div class="valor">${dni.emision}</div></div>
    <div class="dato-line"><div class="label">Vencimiento:</div><div class="valor">${dni.vencimiento}</div></div>
  </div>`;
  if(modo==='moderador'){
    const b=document.createElement('button');
    b.textContent='Eliminar';
    b.className='btn red';
    b.onclick=()=>{if(confirm('Eliminar DNI?')){cedulas.splice(cedulas.indexOf(dni),1);guardarCedulas();renderizarDNI(modo);}};
    div.appendChild(b);
  }
  return div;
}

// --- Policía / Moderador ---
document.getElementById('btnPolicia').onclick=()=>{
  const p=prompt('Contraseña Policía:'); if(p!=='CarabCl') return alert('Contraseña incorrecta');
  document.getElementById('pantallaInicio').style.display='none';
  document.getElementById('modoPolicia').style.display='block';
  renderizarDNI('policia');
}
document.getElementById('btnBuscarPol').onclick=()=>{
  renderizarDNI('policia',document.getElementById('buscarUsuarioPol').value.trim());
}
document.getElementById('cerrarPolicia').onclick=()=>{
  document.getElementById('modoPolicia').style.display='none';
  document.getElementById('pantallaInicio').style.display='block';
}
document.getElementById('btnModerador').onclick=()=>{
  const p=prompt('Contraseña Moderador:'); if(p!=='Estrella2017') return alert('Contraseña incorrecta');
  document.getElementById('pantallaInicio').style.display='none';
  document.getElementById('modoModerador').style.display='block';
  renderizarDNI('moderador');
}
document.getElementById('btnBuscarMod').onclick=()=>{
  renderizarDNI('moderador',document.getElementById('buscarUsuarioMod').value.trim());
}
document.getElementById('cerrarMod').onclick=()=>{
  document.getElementById('modoModerador').style.display='none';
  document.getElementById('pantallaInicio').style.display='block';
}

// --- Mostrar DNIs ---
function renderizarDNI(modo,filtro=''){
  const cont=modo==='policia'?document.getElementById('dniPolicia'):document.getElementById('dniModerador');
  cont.innerHTML='';
  cedulas.filter(d=>!filtro||d.usuario.includes(filtro)).forEach(d=>cont.appendChild(crearCedulaHTML(d,modo)));
}

// Inicializar estado del login
actualizarBotonesLogin();
</script>
</body>
</html>