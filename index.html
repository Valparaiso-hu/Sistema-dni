<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Civil | CHCRP</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-orange: #ff8800; /* Naranja principal */
            --dark-black: #0b0b0b;
            --text-color: #f0f0f0;
            --secondary-gold: #FFD700;
            --input-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 136, 0, 0.4);
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            /* Fondo degradado naranjo a negro (animado) */
            background: linear-gradient(-45deg, #ff8a00, #000000, #ff5a00, #0b0b0b);
            background-size: 400% 400%;
            animation: bgmove 12s ease infinite;
            min-height: 100vh;
            padding: 20px;
        }

        @keyframes bgmove {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
        }

        h1 {
            text-align: center;
            color: var(--primary-orange);
            font-weight: 700;
            text-shadow: 0 0 15px rgba(255, 136, 0, 0.7);
            border-bottom: 3px solid var(--secondary-gold);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        /* --- Estilo de Botones Degradados --- */
        .btn-degradado {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin-top: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s ease;
            color: var(--dark-black);
            background: linear-gradient(90deg, #ffb347, var(--primary-orange));
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.4);
        }

        .btn-degradado:hover {
            background: linear-gradient(90deg, #ff9f1c, #ffaa33);
            box-shadow: 0 6px 20px rgba(255, 136, 0, 0.6);
            transform: translateY(-2px);
        }
        
        /* Bot√≥n de Modo */
        .btn-modo {
            background: var(--dark-black);
            color: var(--secondary-gold);
            border: 2px solid var(--secondary-gold);
            width: auto;
            display: inline-block;
            padding: 8px 15px;
            font-size: 0.9em;
            margin: 10px 5px 20px 0;
            float: right;
        }
        .btn-modo:hover {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
            box-shadow: none;
            transform: none;
        }

        /* --- Estilo de Formularios y Inputs --- */
        .form-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .form-group h3 {
            color: var(--primary-orange);
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            margin-top: 10px;
            color: var(--secondary-gold);
            font-weight: 400;
        }

        input[type="text"], input[type="date"], select, textarea, input[type="password"] {
            width: 100%;
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .dni-card {
            background: var(--input-bg);
            border: 2px solid var(--primary-orange);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            gap: 20px;
            margin-top: 30px;
            box-shadow: 0 0 20px rgba(255, 136, 0, 0.2);
        }

        .dni-photo-container {
            width: 120px;
            height: 150px;
            border: 2px solid var(--secondary-gold);
            overflow: hidden;
            border-radius: 5px;
            background: #222;
            flex-shrink: 0;
        }

        .dni-details {
            flex-grow: 1;
        }

        .section-separator {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px dashed var(--border-color);
        }

        .historial-list {
            list-style: none;
            padding: 0;
        }
        .historial-list li {
            background: rgba(255, 136, 0, 0.1);
            border-left: 5px solid var(--primary-orange);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .mode-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(255, 136, 0, 0.05);
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-orange);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .discord-popup {
            background: #23272a; 
            border: 1px solid #7289da;
            padding: 25px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 0 20px rgba(114, 137, 218, 0.5);
        }
    </style>
</head>
<body onload="checkDiscordLogin()">

<div class="container">
    <button class="btn-modo" id="policeModeBtn" onclick="openModeLogin('police')">Modo Policial</button>
    <button class="btn-modo" id="modModeBtn" onclick="openModeLogin('mod')">Modo Moderador</button>
    
    <h1>Registro Civil - Chile Roleplay</h1>

    <div id="authSection">
        <div id="loadingStatus" style="display:none;">
            <div class="loader"></div>
            <p style="text-align:center;">Verificando credenciales de Discord...</p>
        </div>
        
        <div id="discordAccessRequest" class="discord-popup" style="display:none;">
            <h3>Acceso Requerido</h3>
            <p>Para cargar o crear tu DNI, necesitamos autenticar tu ID de Discord. Haz clic en el bot√≥n para iniciar sesi√≥n en Discord.</p>
            <a id="discordLoginLink" class="btn-degradado" style="background:#7289da; color:white; text-decoration:none;">Iniciar Sesi√≥n con Discord</a>
        </div>
        
        <div id="authError" style="display:none; text-align:center;">
            <p style="color:red;">‚ùå Error de autenticaci√≥n. Int√©ntalo de nuevo.</p>
            <a href="javascript:location.reload()" class="btn-degradado" style="width:50%; margin: 15px auto;">Recargar</a>
        </div>
    </div>

    <div id="mainSection" style="display: none;">
        <p id="welcomeMessage">Bienvenido/a, <span id="discordUsername" style="color:var(--primary-orange);">[Usuario Discord]</span>.</p>
        <div class="form-group">
            <button class="btn-degradado" id="mainActionButton" onclick="checkDNIStatus()">Cargando DNI...</button>
        </div>
    </div>
    
    <div id="createDNISection" style="display: none;">
        <h2>Crear Nuevo DNI (Chile)</h2>
        <p style="color:#aaa;">Este formulario crear√° tu identidad inicial. Una vez registrado, no puedes modificar estos datos t√∫ mismo.</p>
        <form id="dniForm" onsubmit="saveDNI(event)">
            <div class="form-group"><label for="nombre">Nombre</label><input type="text" id="nombre" required></div>
            <div class="form-group"><label for="apellido">Apellido</label><input type="text" id="apellido" required></div>
            <div class="form-group"><label for="nacionalidad">Nacionalidad</label><input type="text" id="nacionalidad" value="Chilena" required></div>
            <div class="form-group"><label for="fechaNacimiento">Fecha de Nacimiento</label><input type="date" id="fechaNacimiento" required></div>
            <div class="form-group">
                <label for="genero">G√©nero</label>
                <select id="genero" required><option value="">Seleccionar</option><option value="M">MASCULINO</option><option value="F">FEMENINO</option></select>
            </div>
            <div class="form-group"><label for="fotoPersonaje">Foto del Personaje (selecci√≥n archivos)</label><input type="file" id="fotoPersonaje" accept="image/*" required></div>
            <button type="submit" class="btn-degradado">Registrar DNI</button>
        </form>
    </div>

    <div id="viewDNISection" style="display: none;">
        <h2>Visualizaci√≥n de DNI</h2>
        
        <div id="dniDataDisplay">
            <div class="dni-card">
                <div class="dni-photo-container"><img id="dniPhoto" class="dni-photo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Foto del Personaje"></div>
                <div class="dni-details">
                    <div class="dni-header">C√âDULA DE IDENTIDAD</div>
                    <p><strong>RUT:</strong> <span id="dniRut"></span></p>
                    <p><strong>N¬∞ Documento:</strong> <span id="dniDocNumber"></span></p>
                    <p><strong>Nombres:</strong> <span id="dniNombre"></span></p>
                    <p><strong>Apellidos:</strong> <span id="dniApellido"></span></p>
                    <p><strong>Nacionalidad:</strong> <span id="dniNacionalidad"></span></p>
                    <p><strong>Nacimiento:</strong> <span id="dniFechaNacimiento"></span></p>
                    <p><strong>G√©nero:</strong> <span id="dniGenero"></span></p>
                </div>
            </div>
        </div>
        
        <div class="section-separator">
            <h3>Historial Policial</h3>
            <div id="policeHistorial">
                </div>
        </div>
        
    </div>

    <div id="modeLoginSection" style="display: none;">
        <h2>Acceso a Modo <span id="modeName"></span></h2>
        <p id="modeLoginInfo">Ingresa la contrase√±a para el modo <span id="modeInfoName"></span>:</p>
        <div class="form-group"><label for="modePassword">Contrase√±a</label><input type="password" id="modePassword" required></div>
        <button class="btn-degradado" onclick="attemptModeLogin()">Acceder</button>
        <p id="statusMessage" style="color:red;"></p>
    </div>

    <div id="policeModeSection" class="mode-section">
        <h3>üö® Modo Policial: Gesti√≥n Ciudadana</h3>
        <p>A√±adiendo registros a: <span id="policeTargetName" style="color: var(--primary-orange);">N/A</span> (ID: <span id="policeTargetId" style="color: var(--secondary-gold);">N/A</span>)</p>

        <div class="form-group">
            <h3>‚öñÔ∏è Registrar Antecedente o Multa</h3>
            <p style="color:#aaa; font-size:0.9em;">Los campos Nombre y RUT se llenan autom√°ticamente al buscar el ciudadano.</p>
            
            <label for="recordNombreCompleto">Nombre Completo</label>
            <input type="text" id="recordNombreCompleto" disabled>
            
            <label for="recordRut">RUT</label>
            <input type="text" id="recordRut" disabled>
            
            <label for="recordTipo">Tipo de Registro</label>
            <select id="recordTipo" required>
                <option value="">Seleccionar Tipo</option>
                <option value="antecedentes">Antecedente Policial</option>
                <option value="multas">Multa Vial/Penal</option>
            </select>
            
            <label for="recordArticulos">Art√≠culos / Descripci√≥n del Delito</label>
            <textarea id="recordArticulos" rows="2" required></textarea>
            
            <label for="recordMonto">Monto Total ($)</label>
            <input type="text" id="recordMonto" value="0" pattern="[0-9]*" title="Solo n√∫meros" required>
            
            <button class="btn-degradado" style="margin-top:10px; background: linear-gradient(90deg, #bb0000, #ff5555);" onclick="processPoliceRecord()">Registrar</button>
        </div>

        <div class="form-group">
            <h3>üöó Registrar Veh√≠culo</h3>
            <label for="vehiculoMarca">Marca</label><input type="text" id="vehiculoMarca" required>
            <label for="vehiculoModelo">Modelo</label><input type="text" id="vehiculoModelo" required>
            <label for="vehiculoPatente">Patente</label><input type="text" id="vehiculoPatente" required>
            <label for="vehiculoColor">Color</label><input type="text" id="vehiculoColor" required>
            <label for="vehiculoAnio">A√±o</label><input type="text" id="vehiculoAnio" pattern="\d{4}" title="Debe ser un a√±o de 4 d√≠gitos" required>
            <button class="btn-degradado" style="margin-top:10px; background: linear-gradient(90deg, #008800, #33cc33);" onclick="addVehicle()">Agregar Veh√≠culo</button>
        </div>
    </div>

    <div id="modModeSection" class="mode-section">
        <h3>üõ†Ô∏è Modo Moderador: Gesti√≥n de Usuarios</h3>
        <p>Eliminar DNI de un usuario por su ID de Discord (¬°ACCI√ìN IRREVERSIBLE!).</p>
        <div class="form-group"><label for="deleteDiscordId">ID de Discord del Usuario a Eliminar</label><input type="text" id="deleteDiscordId"></div>
        <button class="btn-degradado" style="background: #990000;" onclick="deleteDNI()">Eliminar DNI de la Nube</button>
    </div>

</div>

<script>
    // üõë CONFIGURACI√ìN DE DISCORD (REAL) üõë
    const DISCORD_CLIENT_ID = '1432561153183186974'; 
    const DISCORD_REDIRECT_URI = window.location.origin + window.location.pathname; 
    const DISCORD_SCOPES = 'identify';
    const DISCORD_AUTH_URL = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(DISCORD_REDIRECT_URI)}&response_type=code&scope=${DISCORD_SCOPES}`;

    // üõë CONFIGURACI√ìN DE JSONBIN (REAL) üõë
    const JSONBIN_MASTER_KEY = '$2a$10$1/3kX.qVc94dpnjusKsE.uk4ChBxTpPhAtcNtERLAqapNZmTAcqHW'; 
    const JSONBIN_ID = '6915c8e0ae596e708f56ad29'; 
    const JSONBIN_API_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`; 
    
    // --- VARIABLES DE SEGURIDAD Y ESTADO ---
    const POLICE_PASS = "CarabinerosDeChileCHCRP";
    const MODERATOR_PASS = "AdministracionCHCRP";
    let discordUserId = null; 
    let discordUsername = null;
    let currentDNI = null; 
    let currentMode = null; 

    // --- Funciones de Utilidad ---
    function generateRut() { const num = Math.floor(1000000 + Math.random() * 90000000) + ''; let rut = num; let M = 0, S = 1; for (; rut; rut = Math.floor(rut / 10)) { S = (S + rut % 10 * (9 - M++ % 6)) % 11; } const dv = S ? S - 1 : 'K'; const formattedRut = num.replace(/^(\d{1,2})(\d{3})(\d{3})$/, '$1.$2.$3') + '-' + dv; return formattedRut; }
    function generateDocNumber() { return Math.floor(10000000 + Math.random() * 90000000); }


    // --- Funciones de JSONBin (IMPLEMENTACI√ìN REAL) ---
    
    /**
     * Funci√≥n central para leer toda la base de datos de DNI de JSONBin.
     * @returns {Object} El objeto JSON con todos los DNI, indexados por ID de Discord.
     */
    async function fetchAllDniData() {
        try {
            const response = await fetch(`${JSONBIN_API_URL}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_MASTER_KEY }
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const data = await response.json();
            
            const records = data.record;
            delete records._inicializado; // Elimina la clave de inicializaci√≥n si existe

            return records || {};

        } catch (e) {
            console.error("Error al obtener datos del Bin:", e);
            // Alerta si no es un error de "no encontrado" (que podr√≠a significar que el Bin est√° vac√≠o/no inicializado)
            if (!e.message.includes('404')) alert("ERROR: Fallo al conectar con JSONBin. Revisa tu Bin ID y Master Key.");
            return {};
        }
    }
    
    /**
     * Funci√≥n central para actualizar toda la base de datos de DNI en JSONBin (PUT).
     * @param {Object} allDNIData El objeto JSON completo de DNI a guardar.
     */
    async function updateAllDniData(allDNIData) {
        try {
            // Asegura que el payload no est√© en blanco, a√±ade la clave de inicializaci√≥n si el objeto est√° vac√≠o
            if (Object.keys(allDNIData).length === 0) {
                allDNIData = { "_inicializado": true };
            }
            
            const response = await fetch(JSONBIN_API_URL, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_MASTER_KEY,
                    'X-Bin-Versioning': 'false' // Importante para no generar historial de versiones
                },
                body: JSON.stringify(allDNIData)
            });
            
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            const result = await response.json();
            console.log("JSONBin actualizado con √©xito:", result.metadata.createdAt);
            return true;

        } catch (e) {
            alert("ERROR: Fallo al guardar en JSONBin. Detalle: " + e.message);
            console.error(e);
            return false;
        }
    }

    // --- Funciones de Inicio de Sesi√≥n de Discord ---

    function checkDiscordLogin() {
        document.getElementById('discordLoginLink').href = DISCORD_AUTH_URL;
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');

        if (error) { document.getElementById('loadingStatus').style.display = 'none'; document.getElementById('discordAccessRequest').style.display = 'none'; document.getElementById('authError').style.display = 'block'; return; }
        if (code) {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('discordAccessRequest').style.display = 'none';
            exchangeCodeForUser(code);
            history.replaceState(null, null, window.location.pathname);
        } else {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('discordAccessRequest').style.display = 'block';
        }
        document.getElementById('policeModeSection').style.display = 'none';
        document.getElementById('modModeSection').style.display = 'none';
    }

    async function exchangeCodeForUser(code) {
        // ‚ö†Ô∏è ESTA FUNCI√ìN DEBE LLAMAR A TU BACKEND (SERVER) PARA PROCESAR EL C√ìDIGO DE FORMA SEGURA.
        try {
            // SIMULACI√ìN: Obtenci√≥n de datos del usuario desde el servidor
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            const userData = { id: "123456789012345678", username: "UsuarioReal#1234" }; // Sustituir con datos reales

            discordUserId = userData.id;
            discordUsername = userData.username;
            
            document.getElementById('discordUsername').textContent = discordUsername;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            
            checkDNIStatus();

        } catch (error) {
            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('authError').style.display = 'block';
        }
    }

    // --- L√≥gica del Front-end (CRUD con JSONBin) ---

    async function checkDNIStatus() {
        document.getElementById('mainActionButton').textContent = 'Cargando DNI...';
        
        const allDNI = await fetchAllDniData();
        const storedDNI = allDNI[discordUserId];
        
        if (storedDNI) {
            currentDNI = storedDNI;
            document.getElementById('mainActionButton').textContent = 'Ver mi DNI';
            document.getElementById('mainActionButton').onclick = () => displayDNI(currentDNI);
        } else {
            document.getElementById('mainActionButton').textContent = 'Crear mi DNI';
            document.getElementById('mainActionButton').onclick = () => {
                document.getElementById('mainSection').style.display = 'none';
                document.getElementById('createDNISection').style.display = 'block';
            };
        }
    }
    
    function displayDNI(dni) {
        document.getElementById('dniRut').textContent = dni.rut;
        document.getElementById('dniDocNumber').textContent = dni.docNumber;
        document.getElementById('dniNombre').textContent = dni.nombre;
        document.getElementById('dniApellido').textContent = dni.apellido;
        document.getElementById('dniNacionalidad').textContent = dni.nacionalidad;
        document.getElementById('dniFechaNacimiento').textContent = dni.fechaNacimiento;
        document.getElementById('dniGenero').textContent = dni.genero;

        document.getElementById('viewDNISection').style.display = 'block';
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('createDNISection').style.display = 'none';
        
        if (currentMode === 'police') {
            document.getElementById('policeTargetName').textContent = `${dni.nombre} ${dni.apellido}`;
            document.getElementById('policeTargetId').textContent = dni.id;
            document.getElementById('recordNombreCompleto').value = `${dni.nombre} ${dni.apellido}`;
            document.getElementById('recordRut').value = dni.rut;
            document.getElementById('policeModeSection').style.display = 'block';
        }

        updatePoliceHistorialDisplay(dni);
    }

    async function saveDNI(event) {
        event.preventDefault();
        const fotoInput = document.getElementById('fotoPersonaje');
        if (fotoInput.files.length === 0) { alert("Debe subir una foto."); return; }

        const newDNI = {
            id: discordUserId,
            rut: generateRut(),
            docNumber: generateDocNumber(),
            nombre: document.getElementById('nombre').value,
            apellido: document.getElementById('apellido').value,
            nacionalidad: document.getElementById('nacionalidad').value,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            genero: document.getElementById('genero').value,
            antecedentes: [], 
            multas: [],
            vehiculos: [],
        };
        
        const allDNI = await fetchAllDniData();
        allDNI[discordUserId] = newDNI;
        
        const success = await updateAllDniData(allDNI); 
        
        if(success) {
            currentDNI = newDNI;
            alert("¬°DNI registrado con √©xito! Tu RUT es " + newDNI.rut);
            displayDNI(newDNI);
        }
    }
    
    // --- L√≥gica de Modos ---
    
    function searchCivilian() {
        const targetId = prompt("Modo Policial: Ingresa el ID de Discord del ciudadano a consultar:");
        if (!targetId) return;

        fetchAllDniData().then(allDNI => {
            const targetDNI = allDNI[targetId];
            if (targetDNI) {
                currentDNI = targetDNI;
                displayDNI(targetDNI);
            } else {
                alert("Error: DNI no encontrado para el ID " + targetId);
                document.getElementById('policeTargetId').textContent = 'N/A';
                document.getElementById('policeTargetName').textContent = 'N/A';
            }
        });
    }
    
    // --- NUEVAS FUNCIONES DE FORMULARIOS POLICIALES (CRUD) ---

    async function processPoliceRecord() {
        if (!currentDNI || currentMode !== 'police') { alert("Error: Debe estar en Modo Policial y tener un DNI cargado."); return; }
        
        const recordType = document.getElementById('recordTipo').value;
        const articulos = document.getElementById('recordArticulos').value;
        const monto = parseInt(document.getElementById('recordMonto').value) || 0;

        if (!recordType || !articulos) { alert("Complete todos los campos del registro."); return; }

        const newRecord = {
            fecha: new Date().toLocaleDateString(),
            articulos: articulos,
            monto: monto,
            policia: discordUsername || 'Sistema Policial'
        };

        currentDNI[recordType].push(newRecord); 

        const allDNI = await fetchAllDniData();
        allDNI[currentDNI.id] = currentDNI;
        
        const success = await updateAllDniData(allDNI); 

        if(success) {
            alert(`¬°Registro de ${recordType} agregado con √©xito!`);
            document.getElementById('recordArticulos').value = '';
            document.getElementById('recordMonto').value = '0';
            updatePoliceHistorialDisplay(currentDNI);
        }
    }

    async function addVehicle() {
        if (!currentDNI || currentMode !== 'police') { alert("Error: Debe estar en Modo Policial y tener un DNI cargado."); return; }
        
        const marca = document.getElementById('vehiculoMarca').value;
        const modelo = document.getElementById('vehiculoModelo').value;
        const patente = document.getElementById('vehiculoPatente').value;
        const color = document.getElementById('vehiculoColor').value;
        const anio = document.getElementById('vehiculoAnio').value;
        
        if (!marca || !patente) { alert("Complete al menos la Marca y Patente."); return; }

        const newVehicle = {
            fecha_registro: new Date().toLocaleDateString(),
            marca: marca,
            modelo: modelo,
            patente: patente.toUpperCase(),
            color: color,
            anio: anio
        };

        currentDNI.vehiculos.push(newVehicle);

        const allDNI = await fetchAllDniData();
        allDNI[currentDNI.id] = currentDNI;

        const success = await updateAllDniData(allDNI); 

        if(success) {
            alert(`¬°Veh√≠culo ${patente} agregado con √©xito!`);
            document.getElementById('vehiculoMarca').value = '';
            document.getElementById('vehiculoModelo').value = '';
            document.getElementById('vehiculoPatente').value = '';
            document.getElementById('vehiculoColor').value = '';
            document.getElementById('vehiculoAnio').value = '';
            updatePoliceHistorialDisplay(currentDNI);
        }
    }

    async function deleteDNI() {
        const idToDelete = document.getElementById('deleteDiscordId').value;
        if (!idToDelete || currentMode !== 'mod') { alert("Error: Debe estar en modo moderador e ingresar un ID."); return; }

        if (confirm(`¬øEst√°s seguro de ELIMINAR PERMANENTEMENTE el DNI del usuario con ID ${idToDelete}? ESTO ES CR√çTICO.`)) {
            
            const allDNI = await fetchAllDniData();
            if (allDNI[idToDelete]) {
                delete allDNI[idToDelete]; 
                
                const success = await updateAllDniData(allDNI); 
                
                if(success) {
                    alert(`DNI del usuario ${idToDelete} eliminado de la nube.`);
                    document.getElementById('deleteDiscordId').value = '';
                }
            } else {
                alert("Error: ID no encontrado en la base de datos.");
            }
        }
    }
    
    // --- Funci√≥n de Visualizaci√≥n de Historial (Actualizada) ---

    function updatePoliceHistorialDisplay(dni) {
        const historyDiv = document.getElementById('policeHistorial');
        
        if (currentMode === 'police' || dni.id === discordUserId) {
            let html = '';
            
            // ANTECEDENTES
            html += '<h4>Antecedentes Penales</h4><ul class="historial-list">';
            if (dni.antecedentes.length > 0) {
                dni.antecedentes.forEach(a => {
                    html += `<li><strong>[${a.fecha}]</strong> Art√≠culos: ${a.articulos} - Registrado por: ${a.policia}</li>`;
                });
            } else { html += '<li>Sin antecedentes penales registrados.</li>'; }
            html += '</ul>';

            // MULTAS
            html += '<h4>Multas y Deudas</h4><ul class="historial-list">';
            if (dni.multas.length > 0) {
                dni.multas.forEach(m => {
                    const montoFormat = m.monto.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
                    html += `<li><strong>[${m.fecha}]</strong> ${m.articulos} - Monto: <span style="color:#FFD700;">${montoFormat}</span> - Registrado por: ${m.policia}</li>`;
                });
            } else { html += '<li>Sin multas registradas.</li>'; }
            html += '</ul>';

            // VEH√çCULOS (PERTENENCIAS)
            html += '<h4>Veh√≠culos Registrados</h4><ul class="historial-list">';
            if (dni.vehiculos.length > 0) {
                dni.vehiculos.forEach(v => {
                    html += `<li><strong>${v.patente}</strong> | ${v.marca} ${v.modelo} (${v.anio}) - Color: ${v.color}</li>`;
                });
            } else { html += '<li>Sin veh√≠culos registrados.</li>'; }
            html += '</ul>';
            
            historyDiv.innerHTML = html;
        } else {
            historyDiv.innerHTML = '<p style="color:#aaa;">Acceso denegado. Solo es visible el historial del propio DNI o en Modo Policial.</p>';
        }
    }

    // Funciones de modos (mantenidas)
    function openModeLogin(mode) { 
        document.getElementById('modeLoginSection').style.display = 'block';
        document.getElementById('mainSection').style.display = 'none';
        document.getElementById('viewDNISection').style.display = 'none';
        document.getElementById('createDNISection').style.display = 'none';
        document.getElementById('policeModeSection').style.display = 'none';
        document.getElementById('modModeSection').style.display = 'none';
        
        const name = mode === 'police' ? 'POLICIAL' : 'MODERADOR';
        document.getElementById('modeName').textContent = name;
        document.getElementById('modeInfoName').textContent = name;
        document.getElementById('modePassword').value = '';
        currentMode = mode;
    }

    function attemptModeLogin() { 
        const password = document.getElementById('modePassword').value;
        const statusMsg = document.getElementById('statusMessage');
        statusMsg.textContent = '';

        if (currentMode === 'police' && password === POLICE_PASS) {
            statusMsg.textContent = "Acceso policial concedido. ¬°Busca un DNI para empezar!";
            document.getElementById('modeLoginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block'; 
            document.getElementById('mainActionButton').textContent = 'Buscar Ciudadano por ID (Policial)';
            document.getElementById('mainActionButton').onclick = searchCivilian;
        } else if (currentMode === 'mod' && password === MODERATOR_PASS) {
            statusMsg.textContent = "Acceso moderador concedido. ¬°S√© cuidadoso!";
            document.getElementById('modeLoginSection').style.display = 'none';
            document.getElementById('modModeSection').style.display = 'block';
        } else {
            statusMsg.textContent = "Contrase√±a incorrecta.";
        }
    }
</script>

</body>
</html>
