<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chile City RP — DNI System</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#080707;
    --orange1:#ff7a00;
    --orange2:#ff9b3c;
    --card:#111;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:'Poppins',sans-serif; background:linear-gradient(180deg,#050405,#0b0b0b); color:#fff; -webkit-font-smoothing:antialiased; }
  .container{ max-width:1100px; margin:24px auto; padding:20px; }

  /* Header */
  .header{
    display:flex; align-items:center; gap:16px; justify-content:space-between;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .brand img{ width:64px; height:64px; object-fit:cover; border-radius:10px; }
  .brand h1{ margin:0; font-size:20px; letter-spacing:-0.6px; }
  .login-btn{ padding:10px 16px; border-radius:10px; border:none; cursor:pointer; background: linear-gradient(90deg,var(--orange1),var(--orange2)); color:#120600; font-weight:700; }

  /* Main layout */
  .grid{ display:grid; grid-template-columns: 1fr 420px; gap:18px; margin-top:22px; }
  @media (max-width:980px){ .grid{ grid-template-columns:1fr; } .right { order: -1; } }

  /* Card */
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }

  /* Form */
  form label{ display:block; font-size:13px; margin-top:10px; color:rgba(255,255,255,0.85); }
  input[type=text], input[type=date], select, textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:#fff; margin-top:6px; }
  input[type=file]{ margin-top:8px; color:#fff; }
  .actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
  .btn{ padding:10px 14px; border-radius:999px; border:none; cursor:pointer; font-weight:700; }
  .btn.primary{ background: linear-gradient(90deg,var(--orange1),var(--orange2)); color:#120600; }
  .btn.ghost{ background:transparent; color:#ffdcb3; border:1px solid rgba(255,255,255,0.04); }

  /* DNI preview */
  .dni-card{ background:linear-gradient(180deg,#0f0f0f,#0b0b0b); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); }
  .dni-row{ display:flex; gap:12px; align-items:center; }
  .dni-photo{ width:110px; height:110px; border-radius:8px; background:#222; object-fit:cover; border:2px solid rgba(255,255,255,0.03); }
  .dni-info h2{ margin:0 0 6px; font-size:18px; color:var(--orange2); }
  .muted{ color:rgba(255,255,255,0.65); font-size:13px; }

  /* Panels */
  .panel{ margin-top:12px; }
  .panel h3{ margin:0 0 6px; color:var(--orange2); }
  .list{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
  .list .item{ background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; font-size:14px; border:1px solid rgba(255,255,255,0.03); }

  /* small */
  .small{ font-size:13px; color:rgba(255,255,255,0.7); }
  footer{ text-align:center; margin-top:28px; color:rgba(255,255,255,0.5); font-size:13px; }
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <!-- EDITA AQUI: URL de tu logo -->
        <img id="brandLogo" src="https://via.placeholder.com/160x160.png?text=CHILE+CITY+RP" alt="Logo Chile City RP">
        <div>
          <h1>Chile City RP — Sistema DNI</h1>
          <div class="small">Inicia sesión con Discord para guardar tu DNI</div>
        </div>
      </div>
      <div>
        <button class="login-btn" id="discordLogin">Iniciar sesión con Discord</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: form / DNI -->
      <div>
        <div class="card">
          <h2>Crear DNI</h2>
          <p class="small">Completa los datos y presiona <strong>Crear DNI</strong>.</p>

          <!-- Formulario -->
          <form id="dniForm" onsubmit="return false;">
            <label>Nombre</label>
            <input type="text" id="nombre" required>

            <label>Apellido</label>
            <input type="text" id="apellido" required>

            <label>Nacionalidad</label>
            <input type="text" id="nacionalidad" value="Chileno" required>

            <label>Fecha de nacimiento</label>
            <input type="date" id="fnac" required>

            <label>Género</label>
            <select id="genero" required>
              <option value="Masculino">Masculino</option>
              <option value="Femenino">Femenino</option>
              <option value="Otro">Otro</option>
            </select>

            <label>Imagen (foto)</label>
            <input type="file" id="foto" accept="image/*">

            <div class="actions">
              <button class="btn primary" id="createBtn">Crear DNI</button>
              <button class="btn ghost" id="viewBtn" style="display:none">Ver DNI</button>
              <button class="btn ghost" id="logoutBtn" style="display:none">Cerrar sesión</button>
            </div>
          </form>

          <div id="msg" class="small" style="margin-top:10px"></div>
        </div>

        <!-- DNI preview -->
        <div id="dniPreviewWrap" style="display:none; margin-top:12px;">
          <div class="card dni-card" id="dniPreview">
            <div class="dni-row">
              <img class="dni-photo" id="previewImg" src="" alt="Foto">
              <div class="dni-info">
                <h2 id="pNombre">Nombre Apellido</h2>
                <div class="muted" id="pNac">Nacionalidad: --</div>
                <div class="muted" id="pFNac">Nacimiento: --</div>
                <div class="muted" id="pGenero">Género: --</div>
                <div style="margin-top:8px;">
                  <div class="small">RUT: <strong id="pRUT">--</strong></div>
                  <div class="small">N° Documento: <strong id="pDoc">--</strong></div>
                </div>
              </div>
            </div>

            <div class="panel" id="vehiculosPanel">
              <h3>Vehículos</h3>
              <div id="vehiculosList" class="list"></div>
              <!-- formulario para registrar auto (visible solo en modo policial) -->
              <div id="vehForm" style="display:none; margin-top:8px;">
                <label>Marca</label><input type="text" id="vMarca">
                <label>Modelo</label><input type="text" id="vModelo">
                <label>Patente</label><input type="text" id="vPatente">
                <label>Color</label><input type="text" id="vColor">
                <label>Año</label><input type="text" id="vAnio">
                <div style="margin-top:8px;">
                  <button class="btn primary" id="addVeh">Registrar Auto</button>
                </div>
              </div>
            </div>

            <div class="panel" id="antecedentesPanel" style="margin-top:12px;">
              <h3>Antecedentes</h3>
              <div id="anteList" class="list"></div>

              <div id="antForm" style="display:none; margin-top:8px;">
                <label>RUT (del implicado)</label><input type="text" id="aRut">
                <label>Artículo</label><input type="text" id="aArt">
                <label>Monto total</label><input type="text" id="aMonto">
                <div style="margin-top:8px;">
                  <button class="btn primary" id="addAnt">Registrar Antecedente</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right: paneles policiales / admin -->
      <div class="right">
        <div class="card">
          <h3>Panel policial</h3>
          <p class="small">Introduce la contraseña para entrar al modo policial.</p>
          <input type="password" id="policePass" placeholder="Contraseña policial">
          <div style="margin-top:8px;">
            <button class="btn primary" id="enterPolice">Entrar modo Policial</button>
            <button class="btn ghost" id="exitPolice" style="display:none">Salir modo Policial</button>
          </div>

          <div id="policeActions" style="display:none; margin-top:12px;">
            <p class="small">En modo policial podrás agregar antecedentes y registrar vehículos.</p>
            <div class="small" style="margin-top:8px;">Buscar DNI por RUT para editar:</div>
            <input type="text" id="policeRutSearch" placeholder="XX.XXX.XXX-9">
            <div style="margin-top:8px;">
              <button class="btn primary" id="loadForEdit">Cargar DNI</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Panel administrativo</h3>
          <p class="small">Contraseña de administrador para borrar DNIs.</p>
          <input type="password" id="adminPass" placeholder="Contraseña admin">
          <div style="margin-top:8px;">
            <button class="btn primary" id="enterAdmin">Entrar modo Admin</button>
            <button class="btn ghost" id="exitAdmin" style="display:none">Salir modo Admin</button>
          </div>

          <div id="adminActions" style="display:none; margin-top:12px;">
            <div class="small">Buscar RUT para borrar DNI:</div>
            <input type="text" id="adminRutSearch" placeholder="XX.XXX.XXX-9">
            <div style="margin-top:8px;">
              <button class="btn primary" id="delDniBtn">Borrar DNI</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Buscar DNI</h3>
          <input type="text" id="searchRut" placeholder="XX.XXX.XXX-9">
          <div style="margin-top:8px;">
            <button class="btn ghost" id="searchBtn">Buscar</button>
          </div>
          <div id="searchResult" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <footer>
      &copy; Chile City RP — Sistema DNI (demo). Recuerda no exponer keys en público.
    </footer>
  </div>

<script>
/* ================= CONFIG - EDITA AQUI =======================
  1) DISCORD_CLIENT_ID: 1432561153183186974
  2) DISCORD_REDIRECT_URI:https://discord.com/api/oauth2/authorize?client_id=1432561153183186974&redirect_uri=https%3A%2F%2Fportaldeidentidadchcrp.netlify.app%2F&response_type=token&scope=identify
  3) JSONBIN_SECRET:$2a$10$DeRc0oEFIUQMGppk09gXk.bCGQSM30fcxK02PzZ4.6L/Q6jt3ONWa
  4) JSONBIN_ID: id del bin donde guardarás los DNIs (bin type = JSON)
=============================================================*/
const DISCORD_CLIENT_ID = "1432561153183186974"; // tu client ID de Discord
const DISCORD_REDIRECT_URI = "https://portaldeidentidadchcrp.netlify.app/"; // URL exacta registrada en Discord
const JSONBIN_SECRET = "$2a$10$DeRc0oEFIUQMGppk09gXk.bCGQSM30fcxK02PzZ4.6L/Q6jt3ONWa"; // tu secret de JSONBin
const JSONBIN_ID = "69002f9343b1c97be9863276"; // ID del bin donde guardarás los DNIs

/* Contraseñas (las pediste exactamente) */
const POLICE_PASS_REAL = "CarabinerosDeChileCHCRP";
const ADMIN_PASS_REAL  = "EstrellaCHCRP";

/* END CONFIG */

/* Elementos UI */
const discordLogin = document.getElementById('discordLogin');
const logoutBtn = document.getElementById('logoutBtn');
const createBtn = document.getElementById('createBtn');
const viewBtn = document.getElementById('viewBtn');
const msg = document.getElementById('msg');

const dniPreviewWrap = document.getElementById('dniPreviewWrap');
const previewImg = document.getElementById('previewImg');
const pNombre = document.getElementById('pNombre');
const pNac = document.getElementById('pNac');
const pFNac = document.getElementById('pFNac');
const pGenero = document.getElementById('pGenero');
const pRUT = document.getElementById('pRUT');
const pDoc = document.getElementById('pDoc');

const vehiculosList = document.getElementById('vehiculosList');
const anteList = document.getElementById('anteList');

let currentUser = null; // {id, username, avatar, discriminator}
let myDni = null; // objeto del DNI creado o cargado
let binCache = null; // cache local del contenido del bin

/* ---------- UTILIDADES ---------- */
function setMsg(t, err=false){
  msg.textContent = t;
  msg.style.color = err ? "#ffb3a6" : "#cde4bc";
}

/* parse token from URL hash after Discord redirect (implicit grant) */
function parseHashToken(){
  if(window.location.hash && window.location.hash.includes('access_token')){
    const hash = new URLSearchParams(window.location.hash.slice(1));
    return {
      access_token: hash.get('access_token'),
      token_type: hash.get('token_type'),
      expires_in: hash.get('expires_in')
    };
  }
  return null;
}

/* Discord: get user profile */
async function discordFetchUser(token){
  try{
    const res = await fetch('https://discord.com/api/users/@me', {
      headers: { Authorization: 'Bearer ' + token }
    });
    if(!res.ok) throw new Error('No autorizado: ' + res.status);
    const data = await res.json();
    // build avatar url if exists
    const avatar = data.avatar ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png` : null;
    return { id: data.id, username: data.username, discriminator: data.discriminator, avatar };
  }catch(e){
    console.error('discordFetchUser', e);
    return null;
  }
}

/* Login flow: Redirect a discord OAuth2 (implicit token) */
discordLogin.addEventListener('click', ()=>{
  // EDITA SCOPE si necesitas otros scopes (identify es suficiente)
  const scope = encodeURIComponent('identify');
  const url = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(DISCORD_REDIRECT_URI)}&response_type=token&scope=${scope}`;
  window.location.href = url;
});

/* Logout (local) */
logoutBtn.addEventListener('click', ()=>{
  currentUser = null;
  logoutBtn.style.display = 'none';
  setMsg('Sesión cerrada');
});

/* On load: check token in hash */
(async function initAuth(){
  const t = parseHashToken();
  if(t && t.access_token){
    setMsg('Obteniendo perfil de Discord...');
    const u = await discordFetchUser(t.access_token);
    if(u){ 
      currentUser = u;
      setMsg('Conectado: ' + u.username);
      discordLogin.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
    } else {
      setMsg('Error al obtener perfil. Puede que Discord no permita CORS o el token sea inválido.', true);
    }
    // limpiar hash para UX
    history.replaceState(null, '', window.location.pathname + window.location.search);
  } else {
    setMsg('No has iniciado sesión. Puedes usar Discord o crear el DNI manualmente.');
  }
})();

/* ================== JSONBIN helpers =======================
 We use JSONBin V3 endpoints:
 GET:  https://api.jsonbin.io/v3/b/{JSONBIN_ID}/latest
 PUT:  https://api.jsonbin.io/v3/b/{JSONBIN_ID}
 Headers: X-Master-Key: <JSONBIN_SECRET>
=========================================================== */
async function loadBin(){
  if(binCache) return binCache;
  if(!JSONBIN_ID || !JSONBIN_SECRET) { setMsg('JSONBin no configurado. Reemplaza JSONBIN_ID y JSONBIN_SECRET en el script.', true); throw new Error('jsonbin not configured');}
  setMsg('Cargando base de datos...');
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`;
  const res = await fetch(url, { headers: { 'X-Master-Key': JSONBIN_SECRET } });
  if(!res.ok){ setMsg('Error cargando JSONBin: ' + res.status, true); throw new Error('jsonbin load error'); }
  const j = await res.json();
  binCache = j.record || j; // jsonbin wraps record
  setMsg('Base cargada');
  return binCache;
}

async function saveBin(newData){
  if(!JSONBIN_ID || !JSONBIN_SECRET) { setMsg('JSONBin no configurado.', true); throw new Error('jsonbin not configured');}
  setMsg('Guardando en la base de datos...');
  const url = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
  const res = await fetch(url, {
    method:'PUT',
    headers: {
      'Content-Type':'application/json',
      'X-Master-Key': JSONBIN_SECRET
    },
    body: JSON.stringify(newData)
  });
  if(!res.ok){ setMsg('Error guardando JSONBin: ' + res.status, true); throw new Error('jsonbin save error'); }
  const j = await res.json();
  binCache = j.record || j;
  setMsg('Guardado OK');
  return binCache;
}

/* ---------- RUT y N° Documento generadores ---------- */
function randomDigit(){ return Math.floor(Math.random()*10); }
function genRut(){
  // formato XX.XXX.XXX-9 (simple random, sin cálculo real del dígito verificador)
  const a = Math.floor(Math.random()*90)+10;
  const b = Math.floor(Math.random()*900)+100;
  const c = Math.floor(Math.random()*900)+100;
  const d = Math.floor(Math.random()*10);
  return `${String(a).padStart(2,'0')}.${String(b).padStart(3,'0')}.${String(c).padStart(3,'0')}-${d}`;
}
function genDoc(){
  const a = Math.floor(Math.random()*900)+100;
  const b = Math.floor(Math.random()*900)+100;
  const c = Math.floor(Math.random()*900)+100;
  return `${String(a)}.${String(b)}.${String(c)}`;
}

/* ---------- Image to base64 ---------- */
function fileToBase64(file){
  return new Promise((res, rej)=>{
    if(!file) return res(null);
    const reader = new FileReader();
    reader.onload = ()=> res(reader.result);
    reader.onerror = ()=> rej('error reading file');
    reader.readAsDataURL(file);
  });
}

/* ---------- Crear DNI ---------- */
createBtn.addEventListener('click', async ()=>{
  try{
    // read form
    const nombre = document.getElementById('nombre').value.trim();
    const apellido = document.getElementById('apellido').value.trim();
    const nacionalidad = document.getElementById('nacionalidad').value.trim();
    const fnac = document.getElementById('fnac').value;
    const genero = document.getElementById('genero').value;
    const fotoFile = document.getElementById('foto').files[0];

    if(!nombre || !apellido || !fnac) { setMsg('Completa nombre, apellido y fecha de nacimiento', true); return; }

    setMsg('Procesando foto...');
    const fotoBase64 = await fileToBase64(fotoFile);

    const rut = genRut();
    const doc = genDoc();

    // build object
    const dniObj = {
      id: Date.now() + '-' + Math.floor(Math.random()*9000),
      ownerDiscord: currentUser ? { id: currentUser.id, username: currentUser.username } : null,
      nombre, apellido, nacionalidad, fechaNacimiento: fnac, genero,
      foto: fotoBase64,
      rut, documento: doc,
      vehiculos: [], antecedentes: [],
      createdAt: new Date().toISOString()
    };

    // save to JSONBin
    const bin = await loadBin(); // loads existing object; expected structure: { dnis: [ ... ] }
    if(!bin.dnis) bin.dnis = [];
    bin.dnis.push(dniObj);
    await saveBin(bin);

    myDni = dniObj;
    renderDni(myDni);
    setMsg('DNI creado y guardado. Puedes ver tu DNI.');
    createBtn.style.display = 'none';
    viewBtn.style.display = 'inline-block';
  }catch(e){
    console.error(e);
    setMsg('Error creando DNI: ' + e.message, true);
  }
});

/* ---------- Render DNI ---------- */
function renderDni(d){
  if(!d) return;
  dniPreviewWrap.style.display = 'block';
  previewImg.src = d.foto || 'https://via.placeholder.com/200x200.png?text=Sin+Foto';
  pNombre.textContent = `${d.nombre} ${d.apellido}`;
  pNac.textContent = `Nacionalidad: ${d.nacionalidad}`;
  pFNac.textContent = `Nacimiento: ${d.fechaNacimiento}`;
  pGenero.textContent = `Género: ${d.genero}`;
  pRUT.textContent = d.rut;
  pDoc.textContent = d.documento;

  // list vehiculos
  vehiculosList.innerHTML = '';
  if(d.vehiculos && d.vehiculos.length){
    d.vehiculos.forEach(v=>{
      const div = document.createElement('div'); div.className='item';
      div.textContent = `${v.marca} ${v.modelo} — ${v.patente} — ${v.color} — ${v.anio}`;
      vehiculosList.appendChild(div);
    });
  } else {
    vehiculosList.innerHTML = '<div class="small">Sin vehículos registrados</div>';
  }

  // list antecedentes
  anteList.innerHTML = '';
  if(d.antecedentes && d.antecedentes.length){
    d.antecedentes.forEach(a=>{
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `<strong>RUT:</strong> ${a.rut} — <strong>Artículo:</strong> ${a.art} — <strong>Monto:</strong> ${a.monto}`;
      anteList.appendChild(div);
    });
  } else {
    anteList.innerHTML = '<div class="small">Sin antecedentes</div>';
  }
}

/* ---------- View button ---------- */
viewBtn.addEventListener('click', async ()=>{
  if(myDni) { renderDni(myDni); setMsg('Mostrando DNI'); return; }
  // fallback: open last created by user
  try{
    const bin = await loadBin();
    if(!bin.dnis || !bin.dnis.length) { setMsg('No hay DNIs guardados', true); return; }
    // prefer currentUser's last dni
    let found = null;
    if(currentUser) found = [...bin.dnis].reverse().find(x => x.ownerDiscord && x.ownerDiscord.id === currentUser.id);
    if(!found) found = bin.dnis[bin.dnis.length-1];
    myDni = found;
    renderDni(myDni);
    setMsg('Mostrando DNI encontrado');
  }catch(e){ setMsg('Error: ' + e.message, true); }
});

/* ---------- Buscar DNI (por RUT) ---------- */
document.getElementById('searchBtn').addEventListener('click', async ()=>{
  const r = document.getElementById('searchRut').value.trim();
  if(!r){ setMsg('Introduce un RUT para buscar', true); return; }
  try{
    const bin = await loadBin();
    const found = bin.dnis ? bin.dnis.find(d => d.rut === r) : null;
    const out = document.getElementById('searchResult');
    if(!found){ out.innerHTML = '<div class="small">No se encontró DNI</div>'; return; }
    myDni = found;
    renderDni(myDni);
    setMsg('DNI cargado');
    out.innerHTML = `<div class="small">DNI: ${found.nombre} ${found.apellido} — <button class="btn ghost" onclick="renderDniFromSearch()">Ver</button></div>`;
  }catch(e){ setMsg('Error: ' + e.message, true); }
});

window.renderDniFromSearch = ()=> { if(myDni) renderDni(myDni); };

/* ---------- Panel Policial (login) ---------- */
document.getElementById('enterPolice').addEventListener('click', ()=>{
  const p = document.getElementById('policePass').value;
  if(p === POLICE_PASS_REAL){
    document.getElementById('policeActions').style.display = 'block';
    document.getElementById('enterPolice').style.display = 'none';
    document.getElementById('exitPolice').style.display = 'inline-block';
    document.getElementById('vehForm').style.display = 'block';
    document.getElementById('antForm').style.display = 'block';
    setMsg('Modo Policial activado');
  } else setMsg('Contraseña policial incorrecta', true);
});
document.getElementById('exitPolice').addEventListener('click', ()=>{
  document.getElementById('policeActions').style.display = 'none';
  document.getElementById('enterPolice').style.display = 'inline-block';
  document.getElementById('exitPolice').style.display = 'none';
  document.getElementById('vehForm').style.display = 'none';
  document.getElementById('antForm').style.display = 'none';
  setMsg('Modo Policial desactivado');
});

/* Cargar DNI para editar (modo policial) */
document.getElementById('loadForEdit').addEventListener('click', async ()=>{
  const rut = document.getElementById('policeRutSearch').value.trim();
  if(!rut){ setMsg('Ingresa un RUT para cargar', true); return; }
  try{
    const bin = await loadBin();
    const found = bin.dnis ? bin.dnis.find(d => d.rut === rut) : null;
    if(!found){ setMsg('DNI no encontrado', true); return; }
    myDni = found;
    renderDni(myDni);
    setMsg('DNI cargado para edición');
  }catch(e){ setMsg('Error: ' + e.message, true); }
});

/* Añadir vehículo (modo policial) */
document.getElementById('addVeh').addEventListener('click', async ()=>{
  if(!myDni) { setMsg('Carga un DNI primero', true); return; }
  const marca = document.getElementById('vMarca').value.trim();
  const modelo = document.getElementById('vModelo').value.trim();
  const patente = document.getElementById('vPatente').value.trim();
  const color = document.getElementById('vColor').value.trim();
  const anio = document.getElementById('vAnio').value.trim();
  if(!marca || !patente){ setMsg('Marca y patente son obligatorios', true); return; }
  const veh = { marca, modelo, patente, color, anio, createdAt: new Date().toISOString() };
  try{
    const bin = await loadBin();
    const idx = bin.dnis.findIndex(d => d.id === myDni.id);
    if(idx === -1) { setMsg('DNI no existe en la base', true); return; }
    bin.dnis[idx].vehiculos = bin.dnis[idx].vehiculos || [];
    bin.dnis[idx].vehiculos.push(veh);
    await saveBin(bin);
    myDni = bin.dnis[idx];
    renderDni(myDni);
    setMsg('Vehículo registrado');
  }catch(e){ setMsg('Error: ' + e.message, true); }
});

/* Añadir antecedente (modo policial) */
document.getElementById('addAnt').addEventListener('click', async ()=>{
  const arut = document.getElementById('aRut').value.trim();
  const art = document.getElementById('aArt').value.trim();
  const monto = document.getElementById('aMonto').value.trim();
  if(!arut || !art){ setMsg('RUT y Artículo son obligatorios', true); return; }
  try{
    const bin = await loadBin();
    const idx = bin.dnis.findIndex(d => d.rut === arut);
    if(idx === -1){ setMsg('No existe DNI con ese RUT', true); return; }
    const ant = { rut: arut, art, monto, createdAt: new Date().toISOString() };
    bin.dnis[idx].antecedentes = bin.dnis[idx].antecedentes || [];
    bin.dnis[idx].antecedentes.push(ant);
    await saveBin(bin);
    // if the currently loaded DNI is the same, refresh
    if(myDni && myDni.rut === arut){ myDni = bin.dnis[idx]; renderDni(myDni); }
    setMsg('Antecedente registrado');
  }catch(e){ setMsg('Error: ' + e.message, true); }
});

/* ---------- Panel Admin (borrar DNI) ---------- */
document.getElementById('enterAdmin').addEventListener('click', ()=>{
  const p = document.getElementById('adminPass').value;
  if(p === ADMIN_PASS_REAL){
    document.getElementById('adminActions').style.display = 'block';
    document.getElementById('enterAdmin').style.display = 'none';
    document.getElementById('exitAdmin').style.display = 'inline-block';
    setMsg('Modo Admin activado');
  } else setMsg('Contraseña admin incorrecta', true);
});
document.getElementById('exitAdmin').addEventListener('click', ()=>{
  document.getElementById('adminActions').style.display = 'none';
  document.getElementById('enterAdmin').style.display = 'inline-block';
  document.getElementById('exitAdmin').style.display = 'none';
  setMsg('Modo Admin desactivado');
});

document.getElementById('delDniBtn').addEventListener('click', async ()=>{
  const r = document.getElementById('adminRutSearch').value.trim();
  if(!r){ setMsg('Ingresa RUT a borrar', true); return; }
  try{
    const bin = await loadBin();
    const idx = bin.dnis.findIndex(d => d.rut === r);
    if(idx === -1){ setMsg('No existe DNI con ese RUT', true); return; }
    // confirm
    if(!confirm('¿Borrar permanentemente el DNI con RUT ' + r + '?')) return;
    bin.dnis.splice(idx, 1);
    await saveBin(bin);
    setMsg('DNI borrado');
    if(myDni && myDni.rut === r){ myDni = null; dniPreviewWrap.style.display = 'none'; }
  }catch(e){ setMsg('Error: ' + e.message, true); }
});

/* ============================================================
  Nota: Si JSONBin retorna errores por CORS o seguridad, tendrás
  que mover la API key a un pequeño backend que haga las peticiones.
  ============================================================ */
</script>
</body>
</html>