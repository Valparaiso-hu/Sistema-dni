<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro Civil | Chile City RP</title>
<style>
:root{--azul:#003366;--fondo:#f0f4fb;--blanco:#fff;}
body{font-family:Arial,sans-serif;background:var(--fondo);margin:0;padding:20px;}
h2{color:var(--azul);}
.btn{background:var(--azul);color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin:4px;}
.btn.red{background:#b22222;}
.btn.secondary{background:#6b7fa6;}
input, select{width:100%;padding:6px;margin-top:4px;border-radius:6px;border:1px solid #ccd6ea;}
.card{background:var(--blanco);padding:12px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);margin-bottom:12px;}
.foto-preview{width:120px;height:150px;background:#e9eef9;border:1px dashed #aebfdb;display:flex;align-items:center;justify-content:center;color:#556;margin-top:8px;border-radius:6px;overflow:hidden;}
.foto-preview img{width:100%;height:100%;object-fit:cover;}
.cedula-wrap{margin-top:20px;}
.cedula{position:relative;background:linear-gradient(90deg,#e8f0ff 0%, #ffffff 60%);border:2px solid var(--azul);border-radius:12px;padding:18px;box-shadow:0 8px 22px rgba(0,0,0,0.12);font-size:14px;color:#033;margin-bottom:12px;}
.cedula .flag{font-weight:700;color:var(--azul);text-align:center;letter-spacing:2px;margin-bottom:6px;}
.cedula .photo{position:absolute;left:20px;top:50px;width:120px;height:150px;border:2px solid var(--azul);background:#f6f8ff;overflow:hidden;border-radius:6px;}
.cedula .photo img{width:100%;height:100%;object-fit:cover;}
.datos{margin-left:160px;padding-top:10px;}
.dato-line{display:flex;gap:6px;margin-bottom:8px;align-items:center;}
.label{width:120px;font-weight:700;color:var(--azul);}
.valor{background:rgba(255,255,255,0.6);padding:6px 8px;border-radius:6px;min-width:150px;}
.rut{position:absolute;right:18px;top:18px;background:var(--azul);color:white;padding:8px 10px;border-radius:6px;font-weight:700;}
</style>
</head>
<body>

<h2>Registro Civil | Chile City RP</h2>

<!-- Pantalla de Login -->
<div id="loginCard" class="card">
  <h3>Inicio de Sesión</h3>
  <p>Ingresa tu usuario de Discord y una contraseña.<br><b style="color:red">No utilices tu contraseña de Discord.</b></p>
  <input id="loginUsuario" type="text" placeholder="Usuario de Discord">
  <input id="loginPass" type="password" placeholder="Contraseña">
  <button class="btn" id="btnLogin">Iniciar Sesión</button>
  <button class="btn secondary" id="btnCrearCuenta">Crear Cuenta</button>
</div>

<!-- Pantalla principal -->
<div id="pantallaInicio" class="card" style="display:none;">
  <h3>Bienvenido, <span id="nombreUsuario"></span></h3>
  <button class="btn" id="btnCrearC">Crear Cédula</button>
  <button class="btn" id="btnVerC" style="display:none;">Ver Cédula</button>
  <button class="btn" id="btnPolicia">Entrar como Policía</button>
  <button class="btn" id="btnModerador">Entrar como Moderador</button>
  <button class="btn red" id="btnCerrarSesion">Cerrar Sesión</button>
</div>

<!-- Formulario -->
<div id="formDNI" class="card" style="display:none;">
  <h3>Formulario de Cédula</h3>
  <label>Nombres</label><input id="nombres" type="text">
  <label>Apellidos</label><input id="apellidos" type="text">
  <label>Nacionalidad</label><input id="nacionalidad" type="text" value="Chilena">
  <label>Género</label><select id="genero"><option>Masculino</option><option>Femenino</option></select>
  <label>Fecha de nacimiento</label><input id="nacimiento" type="date">
  <label>Foto</label><input id="foto" type="file" accept="image/*">
  <div class="foto-preview" id="fotoPreviewForm"><span>Previsualización</span></div>
  <button class="btn" id="btnGenerar">Generar Cédula</button>
</div>

<!-- Modo Policía -->
<div id="modoPolicia" class="card" style="display:none;">
  <h3>Modo Policía</h3>
  <input type="text" id="buscarUsuarioPol" placeholder="Buscar usuario...">
  <button class="btn" id="btnBuscarPol">Buscar</button>
  <div id="dniPolicia"></div>
  <button class="btn red" id="cerrarPolicia">Cerrar</button>
</div>

<!-- Modo Moderador -->
<div id="modoModerador" class="card" style="display:none;">
  <h3>Modo Moderador</h3>
  <input type="text" id="buscarUsuarioMod" placeholder="Buscar usuario...">
  <button class="btn" id="btnBuscarMod">Buscar</button>
  <div id="dniModerador"></div>
  <button class="btn red" id="cerrarMod">Cerrar</button>
</div>

<div class="cedula-wrap" id="cedulaWrap"></div>

<script>
const API_URL = "https://api.jsonbin.io/v3/b/68f8c37443b1c97be9780ca6";
const MASTER_KEY = "$2a$10$kkNzvw3iucR3WD0BGh0Sd.4dkN.tZN1";

let usuarioActual = null;
let cuentas = [];
let cedulas = [];

// ---- Funciones JSONBin ----
async function cargarDatos() {
  const res = await fetch(API_URL, { headers: { "X-Master-Key": MASTER_KEY } });
  const data = await res.json();
  return data.record || { cuentas: [], cedulas: [] };
}

async function guardarDatos(datos) {
  await fetch(API_URL, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
    body: JSON.stringify(datos)
  });
}

// ---- Funciones de utilidades ----
function generarNumDocumento(){return Math.floor(100000000 + Math.random()*900000000).toString();}
function generarRutConDV(){
  let r=''; for(let i=0;i<(Math.random()<0.5?7:8);i++) r+=Math.floor(Math.random()*10);
  const rev=r.split('').reverse().map(n=>parseInt(n,10));
  let f=2,s=0; for(const d of rev){s+=d*f;f=f===7?2:f+1;}
  let m=11-(s%11),dv=m===11?'0':m===10?'K':String(m);
  return r.replace(/\B(?=(\d{3})+(?!\d))/g,".")+'-'+dv;
}
function fechaHoyYVencimiento(){
  const hoy=new Date(), fv=new Date(hoy); fv.setFullYear(fv.getFullYear()+5);
  const f=(d)=>String(d).padStart(2,'0');
  return {emision:`${f(hoy.getDate())}-${f(hoy.getMonth()+1)}-${hoy.getFullYear()}`,
          vencimiento:`${f(fv.getDate())}-${f(fv.getMonth()+1)}-${fv.getFullYear()}`};
}

// ---- Renderizado y flujo ----
function mostrarInicio(){
  document.getElementById('loginCard').style.display='none';
  document.getElementById('pantallaInicio').style.display='block';
  document.getElementById('nombreUsuario').textContent=usuarioActual;
  actualizarBotonVerC(usuarioActual);
}

function crearCedulaHTML(dni,modo){
  const div=document.createElement('div'); div.className='cedula';
  div.innerHTML=`<div class="flag">REPUBLICA DE CHILE</div>
  <div class="rut">${dni.rut}</div>
  <div class="photo"><img src="${dni.foto}"></div>
  <div class="datos">
    <div class="dato-line"><div class="label">Nombres:</div><div class="valor">${dni.nombres}</div></div>
    <div class="dato-line"><div class="label">Apellidos:</div><div class="valor">${dni.apellidos}</div></div>
    <div class="dato-line"><div class="label">Género:</div><div class="valor">${dni.genero}</div></div>
    <div class="dato-line"><div class="label">Nacionalidad:</div><div class="valor">${dni.nacionalidad}</div></div>
    <div class="dato-line"><div class="label">F. Nacimiento:</div><div class="valor">${dni.nacimiento}</div></div>
    <div class="dato-line"><div class="label">N° Documento:</div><div class="valor">${dni.numdoc}</div></div>
    <div class="dato-line"><div class="label">F. Emisión:</div><div class="valor">${dni.emision}</div></div>
    <div class="dato-line"><div class="label">F. Vencimiento:</div><div class="valor">${dni.vencimiento}</div></div>
  </div>`;
  if(modo==='moderador'){
    const btn=document.createElement('button');
    btn.textContent='Eliminar'; btn.className='btn red';
    btn.onclick=async()=>{cedulas.splice(cedulas.indexOf(dni),1); await guardarDatos({cuentas,cedulas}); renderizarDNI(modo);};
    div.appendChild(btn);
  }
  return div;
}

function renderizarDNI(modo,filtro=''){
  const cont=document.getElementById(modo==='policia'?'dniPolicia':'dniModerador');
  cont.innerHTML='';
  cedulas.filter(d=>!filtro||d.usuario.includes(filtro))
  .forEach(d=>cont.appendChild(crearCedulaHTML(d,modo)));
}

function actualizarBotonVerC(usuario){
  const existe=cedulas.some(d=>d.usuario===usuario);
  document.getElementById('btnVerC').style.display=existe?'inline-block':'none';
  document.getElementById('btnCrearC').style.display=!existe?'inline-block':'none';
}

// ---- Login ----
document.getElementById('btnLogin').onclick=async()=>{
  const user=document.getElementById('loginUsuario').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  const datos=await cargarDatos();
  cuentas=datos.cuentas; cedulas=datos.cedulas;

  const cuenta=cuentas.find(c=>c.usuario===user);
  if(!cuenta){alert('Cuenta no existe. Crea una nueva.');return;}
  if(cuenta.pass!==pass)return alert('Contraseña incorrecta.');
  usuarioActual=user; mostrarInicio();
};

document.getElementById('btnCrearCuenta').onclick=async()=>{
  const user=document.getElementById('loginUsuario').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  const datos=await cargarDatos(); cuentas=datos.cuentas; cedulas=datos.cedulas;

  if(cuentas.some(c=>c.usuario===user))return alert('Esa cuenta ya existe.');
  cuentas.push({usuario:user,pass}); await guardarDatos({cuentas,cedulas});
  usuarioActual=user; mostrarInicio();
};

// ---- Crear Cédula ----
document.getElementById('btnCrearC').onclick=()=>{document.getElementById('formDNI').style.display='block';document.getElementById('pantallaInicio').style.display='none';};

document.getElementById('foto').addEventListener('change',e=>{
  const file=e.target.files[0]; const prev=document.getElementById('fotoPreviewForm');
  if(!file)return prev.innerHTML='<span>Previsualización</span>';
  const reader=new FileReader(); reader.onload=ev=>prev.innerHTML=`<img src="${ev.target.result}">`; reader.readAsDataURL(file);
});

document.getElementById('btnGenerar').onclick=async()=>{
  const n=document.getElementById('nombres').value.trim();
  const a=document.getElementById('apellidos').value.trim();
  const nac=document.getElementById('nacionalidad').value.trim();
  const g=document.getElementById('genero').value;
  const f=document.getElementById('nacimiento').value;
  const file=document.getElementById('foto').files[0];
  if(!n||!a||!f||!file)return alert('Completa todos los campos.');
  const reader=new FileReader();
  reader.onload=async(e)=>{
    const fechas=fechaHoyYVencimiento();
    const datos=await cargarDatos(); cuentas=datos.cuentas; cedulas=datos.cedulas;
    if(cedulas.some(d=>d.usuario===usuarioActual))return alert('Ya tienes una cédula.');
    cedulas.push({usuario:usuarioActual,nombres:n,apellidos:a,nacionalidad:nac,genero:g,nacimiento:f,foto:e.target.result,
      rut:generarRutConDV(),numdoc:generarNumDocumento(),emision:fechas.emision,vencimiento:fechas.vencimiento});
    await guardarDatos({cuentas,cedulas});
    alert('Cédula creada correctamente ✅');
    document.getElementById('formDNI').style.display='none';
    document.getElementById('pantallaInicio').style.display='block';
    actualizarBotonVerC(usuarioActual);
  };
  reader.readAsDataURL(file);
};

// ---- Ver Cédula ----
document.getElementById('btnVerC').onclick=()=>{
  const dni=cedulas.find(d=>d.usuario===usuarioActual);
  const wrap=document.getElementById('cedulaWrap'); wrap.innerHTML=''; wrap.appendChild(crearCedulaHTML(dni,'usuario'));
};

// ---- Modo Policía ----
document.getElementById('btnPolicia').onclick=async()=>{
  const pass=prompt('Contraseña Policía:');
  if(pass!=='CarabCl')return alert('Contraseña incorrecta.');
  const datos=await cargarDatos(); cedulas=datos.cedulas;
  document.getElementById('pantallaInicio').style.display='none';
  document.getElementById('modoPolicia').style.display='block';
  renderizarDNI('policia');
};
document.getElementById('btnBuscarPol').onclick=()=>{renderizarDNI('policia',document.getElementById('buscarUsuarioPol').value.trim());};
document.getElementById('cerrarPolicia').onclick=()=>{document.getElementById('modoPolicia').style.display='none';document.getElementById('pantallaInicio').style.display='block';};

// ---- Modo Moderador ----
document.getElementById('btnModerador').onclick=async()=>{
  const pass=prompt('Contraseña Moderador:');
  if(pass!=='Estrella2017')return alert('Contraseña incorrecta.');
  const datos=await cargarDatos(); cedulas=datos.cedulas;
  document.getElementById('pantallaInicio').style.display='none';
  document.getElementById('modoModerador').style.display='block';
  renderizarDNI('moderador');
};
document.getElementById('btnBuscarMod').onclick=()=>{renderizarDNI('moderador',document.getElementById('buscarUsuarioMod').value.trim());};
document.getElementById('cerrarMod').onclick=()=>{document.getElementById('modoModerador').style.display='none';document.getElementById('pantallaInicio').style.display='block';};
</script>
</body>
</html>